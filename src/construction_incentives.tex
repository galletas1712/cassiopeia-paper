\section{Incentives}\label{section:construction_incentives}
% Construction overview
Here, we augment the scheme in Section~\ref{section:construction_without_incentives} to incentivize committee members to act honestly.
We will create incentives for the committee to reveal on time so that the secret is recoverable.
This will be done by paying out a reward to the committee members who reveal at the right time, while slashing committee members who do not.
If every committee member is honest, everyone will be rewarded.
This way, we will ensure correctness.
Unfortunately, we cannot use slashing to ensure security, as malicious committee members can always reveal confidential information off-chain and the smart contract has no way of knowing this, so our goal will only be correctness.

Initially, the dealer names a \emph{reparation price} of their choice, which they are guaranteed to be paid in case the secret is irrecoverable.
The contract requests from the dealer to pay a certain \emph{holding fee}.
The larger the reparation price, the larger the holding fee. 
The holding fee is the reward that honest committee members will share amongst themselves upon the completion of the protocol and the correct retrieval of the secret.
At the same time, each committee member puts in a certain \emph{collateral}, which is held by the contract in escrow until the completion of protocol, in case the committee member misbehaves.
This collateral will be slashed in case of misbehavior.
In case a majority of committee members are dishonest, and the secret is irrecoverable, the slashing amounts are sufficient to add up to the reparation price which is used to appease the dealer in the case of failure.
% The collaterals requested by the contract are also a function of the reparation price, and are calculated as follows:

% Happy path
Consider the happy path, where the dealer and all committee members are honest.
Let $f$ be the holding fee of the secret.
When the dealer makes an encryption request, he transfers $f$ to the contract.
After a call to \textsf{claim} with a valid witness, committee members submit their shares.
As soon as a committee member submits a valid share, they receive their reward.
The holding fee is split equally amongst all committee members to cover their reward payments, so each committee member's reward is $\frac{f}{n}$.

% Semi-happy path
Now consider the scenario where the committee has at least $t$ honest members, but not all of them are honest.
Dishonest committee members may choose to not submit their shares.
If any committee member does not submit their share, they do not receive their reward of $\frac{f}{n}$.
Instead, it is transferred back to the dealer.

% Sad path, define amount to slash
Now consider the case where the secret is irrecoverable.
In particular, there are less than $t$ committee members who submit their shares, so there are less than $t$ honest committee members.
Every dishonest committee member has their collateral slashed equally, on top of already not receiving their reward.
Concretely, suppose only $t'$ committee members reveal valid shares.
Let $b$ be the amount of collateral slashed per committee member, and suppose the smart contract is given the reparation price $a$.
The sum of every dishonest committee member's slashed collateral and forfeited reward must add up to $a$, i.e. $a = (n - t')(b + \frac{f}{n})$.
Therefore, each dishonest committee member is slashed exactly
\begin{equation}\label{eq:slash_amount}
    b = \frac{a}{n - t'} - \frac{f}{n}
\end{equation}
The contract keeps track of an escrow balance $cl_i$ for each committee member $i$ that is used as collateral.
Whenever the committee member is slashed, $cl_i$ is deducted.
Whenever the committee member earns rewards (i.e. committee member $i$ submits a valid share), $cl_i$ is added to.
We introduce a function \textsf{slash} that slashes committee members and transfers the reparation price to the dealer as outlined above.

\begin{algorithm}[H]
\caption{Cassiopeia \textsf{slash} function}
\label{alg:slash}
    \begin{algorithmic}[1]
            \Function{\sf slash}{$i$}
                \State require($M_{id} = \textsc{claimed} \land \textsf{block.number} \geq D_{id}$)
                \State $\{\textsf{dealer}, a, f, \dots\} \gets C_{id}$
                \State $t' \gets |S_{id}|$
                \State $G \gets 0$
                \State $b \gets \frac{a}{n - t'} + \frac{f}{n}$ \Comment{Equation~\ref{eq:slash_amount}}
                \State $\hat{b} \gets \frac{a}{n - t + 1} + \frac{f}{n}$ \Comment{Equation~\ref{eq:collateral_requirement}}
                \For{$i \in [n]$}
                    \If{$S_{id,i} = \bot$}
                        \If{$t' < t$}
                            \State $cl_i \gets cl_i - b$
                            \State $G \gets G + b$
                        \EndIf
                        \State $G \gets G + \frac{f}{n}$
                    \EndIf
                \EndFor
                \State $\textsf{dealer.send}(G)$
                \State $l \gets l - \hat{b}$ 
                \State $M_{id} \gets \textsc{slashed}$
            \EndFunction
    \end{algorithmic}
\end{algorithm}

% Amount of collateral needed to lock
To ensure the contract can use a committee member's collateral to pay the reparation price, the committee member must have deposited at least $b$ inside the contract before \textsf{encrypt} can be called.
However, the number of honest committee members who will submit valid shares $t'$ is unknown at the time of an \textsf{encrypt} request.
Therefore, the contract must ensure that each committee member has deposited at least the maximum slashable amount given the reparation price.
Let $\hat{b}$ be the amount of funds a committee member is required to deposit.
\begin{equation}\label{eq:collateral_requirement}
    \hat{b} = \argmax_{0 \leq t' \leq t - 1} b = \frac{a}{n - t + 1} - \frac{f}{n}
\end{equation}

% Opp cost
Notice that each committee member's collateral is locked inside the contract for the lifetime of the secret.
However, the locked funds do not earn interest, which introduces an opportunity cost for committee members.
To incentivize committee members to participate in the protocol honestly, the reward must be higher than the opportunity cost.
Concretely, let $d$ be the \emph{maximum lifespan} of the secret in blocks, and $\beta$ be the agreed-upon time value of the net profit for honest committee members.
The opportunity cost for locking $\hat{b}$ as collateral inside the contract for $d$ blocks is
\begin{equation}\label{eq:opp_cost}
    o = \hat{b}((1 + r)^d - 1)
\end{equation}
where $r$ is the per-block risk-free rate agreed upon by all committee members.
Now, we can derive the reparation price $a$ instead of assuming it is given to the smart contract.
Using $\beta = \frac{f}{n} - o$, Equation~\ref{eq:collateral_requirement} and Equation~\ref{eq:opp_cost}, we have:
\begin{gather}\label{eq:collateral_from_holding_fee}
    % \frac{f}{n} = \beta + \hat{b}((1 + r)^d - 1) \\
    % \frac{f}{n} = \beta + (\frac{a}{n - t + 1} - \frac{f}{n})((1 + r)^d - 1) \\ 
    % \frac{f}{n}(1 + r)^d = \beta + (\frac{a}{n - t + 1})((1 + r)^d - 1) \\
    % \frac{f}{n}(1 + r)^d - \beta = \frac{a}{n - t + 1}((1 + r)^d - 1) \\
    % \frac{\frac{f}{n}(1 + r)^d - \beta}{(1 + r)^d - 1} = \frac{a}{n - t + 1} \\
    a = \frac{(\frac{f}{n}(1 + r)^d - \beta)(n - t + 1)}{(1 + r)^d - 1}
\end{gather}

% Timelock
We would like the contract to compute the reparation price $a$ directly from the holding fee.
To do so, the maximum lifespan of the secret $d$ must be known.
However, for an arbitrary relation $\mathcal{R}$ the witness may take an arbitrary amount of time to be found.
Therefore, we require the dealer to also provide the maximum number of blocks $T$ that committee members will keep the secret for.
Let $st$ be the block where the encryption request was first made.
We modify the original \textsf{claim} function to start decryption at block $st + T$ even if no valid witness has been revealed.

The lifespan of the secret also includes the number of blocks between when the secret is claimed and when committee members are slashed.
For the maximum lifespan of the secret to be known, everyone must agree upon a share submission deadline $D_{id}$ after which committee members are slashed.
The deadline $D_{id}$ is set to $\Delta$ blocks after the secret is claimed.
Honest committee members must submit their shares by block $D_{id}$.
Therefore, the secret's maximum lifespan is $d = T + \Delta$, and is known at encryption time.
The \textsf{claim} function is modified as follows.

\begin{algorithm}[H]
\caption{Modified Cassiopeia \textsf{claim} function}
    \begin{algorithmic}[1]
            \Function{\sf claim}{$id, w$}
                \State require($M_{id} = \bot$)
                \State $\{st, x, T\} \gets C_i$
                \State require($\textsf{block.number} \geq st + T \lor (x, w) \in \mathcal{R}$)
                \State $D_{id} \gets \textsf{block.number} + \Delta$
                \State $M_{id} \gets \textsc{claimed}$
            \EndFunction
    \end{algorithmic}
\end{algorithm}

% Many secrets liabilities
We call a secret \emph{active} if \textsf{slash} has not been called for the secret.
Because there may be many active secrets at any point in time, the contract must ensure that there are sufficient funds locked in escrow to cover all reparation price liabilities.
To do so, the contract keeps track of $l$, which is equal to the sum of $\hat{b}$ for all secrets.
During an encryption request, the contract ensures that for each committee member $i$, the remaining unused collateral $cl_i - l$ is sufficient to cover $\hat{b}$ for the new secret (see Line 9 of Algorithm~\ref{alg:encrypt_incentives}).

The fully modified \textsf{encrypt} function is shown below.
\begin{algorithm}[H]
\caption{Modified Cassiopeia \textsf{encrypt} function}
\label{alg:encrypt_incentives}
    \begin{algorithmic}[1]
            \Function{\sf encrypt}{$c, \mathcal{R}, x, T, y, \pi$} \textbf{payable}
                \CommentLine{Incentives}
                \State $d \gets T + \Delta$
                \State $f \gets \textsf{msg.value}$

                \State $a \gets \frac{(\frac{f}{n}(1 + r)^d - \beta)(n - t + 1)}{(1 + r)^d - 1}$ \Comment{Equation~\ref{eq:collateral_from_holding_fee}}
                \State $\hat{b} \gets \frac{a}{n - t + 1} - \frac{f}{n}$ \Comment{Equation~\ref{eq:collateral_requirement}}
                \For{$i \in [n]$}
                    \State require($cl_i \geq l + \hat{b}$)
                \EndFor
                \State $l \gets l + \hat{b}$
                \State $st \gets \textsf{block.number}$

                \CommentLine{Verify PVSS and zkSNARK}
                \State $([\hat{s}_i], \pi_D) \gets c$
                \State require($V(\tau, (c, \mathcal{R}, x, T, y, [pk_i]), \pi) = 1 \land \textsf{PVSS.verifyDist}([\hat{s}_i], [pk_i], \pi_D)$)

                \State $id \gets H(c, \mathcal{R}, x, T)$
                \State $C_{id} \gets \{c, \mathcal{R}, x, T, [\hat{s}_i], f, a, st\}$

                \State \Return $id$
            \EndFunction
    \end{algorithmic}
\end{algorithm}

Lastly, we must allow committee members to withdraw their collateral to collect their fees or stop participating in the protocol.
The only requirement is that the remaining collateral is sufficient to cover the worst case reparation price for all active secrets.
Suppose committee member $i$ wants to withdraw $\delta_{cl}$.
They can do so only if $cl_i - \delta_{cl} \geq l$.
Note that the contract also keeps track of the address of each committee member $addr_i$ to ensure only committee member $i$ is entitled to their collateral.
The pseudocode for depositing and withdrawing collateral is shown below.

\begin{algorithm}[H]
\caption{Depositing and withdrawing collateral from Cassiopeia}
    \begin{algorithmic}[1]
        \Function{\sf depositCollateral}{$i$} \textbf{payable}
            \State $cl_i \gets cl_i + \textsf{msg.value}$
        \EndFunction

        \Function{\sf withdrawCollateral}{$i, \delta_{cl}$}
            \State require($\textsf{msg.sender} = addr_i \land cl_i - \delta_{cl} \geq l$)
            \State $cl_i \gets cl_i - \delta_{cl}$
            \State $\textsf{msg.sender.send}(\delta_{cl})$
        \EndFunction
    \end{algorithmic}
\end{algorithm}
